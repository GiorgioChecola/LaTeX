\label{improvedmethod}
Results of \autoref{results} have shown the need to develop an approach that generates a spatio-temporal map that accounts for wave forecasts to constrain the navigation in safe zones.
%with the certainty of finding in safe zone during the navigation.
This chapter covers its development, introducing the basic idea and the creation steps. Then, the improved method is tested with simulations performed by the path planning algorithm RRT*.

\section{Review of basic spatio-temporal approaches}
\textbf{\textit{Sum}}, \textbf{\textit{Global}}, and \textbf{\textit{Local}}'s features represent the basis for creating a more accurate map. For example, the idea of summing time windows is necessary to consider wave conditions in the nearest future. The \textbf{\textit{Local}}'s concept of dividing the configuration space into temporal bands is the key principle of the new method. Finally, the possibility of re-planning every amount of time, conducted by the \textbf{\textit{Global}} approach, could be implemented in the future if an update of forecasts is provided.
%each of them have some aspects that could be exploited for the development of the improved method. 
% conducted
Regarding the \textbf{\textit{Sum}} approach, adding the forecasts of every hour throughout the region of interest is ineffective. By dividing the configuration space into temporal bands, we can see that wave conditions at $t_{i-1}$ are negligible in the temporal band $i$. The reason is that the vessel will take at least one hour to cross each band, and so the added time window would represent information about the past. Figure \ref{improved1} displays this statement.
\begin{figure}[H]
	\centering
	\includegraphics[width=65mm]{Figures/improved1.png}
	\caption{Improvement of \textbf{\textit{Sum}} approach}
	\label{improved1}
\end{figure}

On the other hand, the map generated by \textbf{\textit{Local}} corresponds to the ideal case in which the boat will reach its destination by crossing each strip in precisely 1 hour. Therefore, the aim is to generate a global weather map using the least number of time windows to guarantee that the vessel will always remain in the navigation area. This approach solves the \textbf{\textit{Sum}} and \textbf{\textit{Global}}'s problem of low efficiency and the strong assumption on which \textbf{\textit{Local}} is designed that penalizes the safety.
% that is a middle ground between the two approaches,
\section{Optimal map generation}
The improved approach represents a middle ground between \textbf{\textit{Local}} and \textbf{\textit{Sum}}, and it consists in starting from the ideal path generated by \textbf{\textit{Local}} - since it is always feasible - updating the map, and recalculating the entire path. In order to facilitate this operation, we created a multidimensional masked array that includes the presence of wave conditions at $t_i$, where $i=0,1,\dots,N-1$, in every temporal band $b_j$, where $j=0,1,\dots,N_b-1$ (see Figure \ref{bandmap567}). 
\newpage
\begin{figure}[H]
	\centering 
	\subfloat[\texttt{band\_map[5][5]}]{\includegraphics[width=0.32\textwidth]{Figures/bandmap55.png}\label{bandmap55}}
	\hspace{0.1cm}
	\subfloat[\texttt{band\_map[5][6]}]{\includegraphics[width=0.32\textwidth]{Figures/bandmap56.png}\label{bandmap56}}
	\hspace{0.1cm}
	\subfloat[\texttt{band\_map[5][7]}]{\includegraphics[width=0.32\textwidth]{Figures/bandmap57.png}\label{bandmap57}}
	\vspace{0.0cm}
	%\captionsetup[subfigure]{font=tiny,labelfont=tiny}
	%\captionsetup{font=normalsize,labelfont=footnotesize}
	\caption{$H_{m0}>0.8$ of time window $t_5, t_6, t_7$ in band $b_5$ for an arbitrary day} 
	\label{bandmap567}
\end{figure}

The algorithm can be schematized in the following steps:
\begin{enumerate}[itemsep=0pt]
	\item Perform path planning using \textbf{\textit{Local}} approach;
	\item Find the intersections of the path with the circular bands: \\ 
	$P_j$, $\forall j \in \{0,1,\ldots,N_b-1\}$ where $N_b$ is the number of intersections until the survey point;
	\item Calculate the travel time $f_j$ between consecutive intersections $P_j,P_{j+1}$ and the corresponding time from the starting point ${f_{tot}}_j = \sum_{k=0}^{j}f_k$ ;
	\item Based on ${f_{tot}}_j$, adjust the number of time windows to the minimum next higher integer and regenerate the map;
	\item Repeat the path planning with the new map of obstacles;
	\item Start the next iteration of the loop from step 2 and verify that ${f_{tot}}_j< {T_{max}}_j$, which is the maximum time to cross band $b_j$ while preserving USV safety;
	\item If condition 6 is met, return the path. Otherwise, continue from step 4.
\end{enumerate}
%A map generated in this way provides a better path than the one obtained with \textbf{\textit{Sum}} because fewer obstacles will be present in the configuration space $\mathcal{C}_{space}$.
%This modification represents just a slight improvement. That is why another approach has been conceived.
%\textcolor{red}{The optimal solution would a tradeoff between all the methods. Sum is the suboptimal but it assures not to go in unsafe zone. Global is a possibility, and we could account for a grade of prediction on how the wavefront moves based on velocity and direction of the waves and/or currents. Local method is the best but it still an approximation. An improved version could be overlapped bands, with length which depends on the time distance between the theoretical end point of the band, and the one actually reached. Indeed the drawback of this method is that the boat will never reach the end of each band in one hour}.
The pseudo-code of the improved method is illustrated in Algorithm \ref{improvedlocal}. 

\vspace{0.8cm}
Figure \ref{compsumlocimpr} compares the maps generated by three spatio-temporal approaches for the same day. Depending on how the time windows are summed, $\mathcal{C}_{obs}$ will change, resulting in different deliberative paths. \textbf{\textit{Sum}} and \textbf{\textit{Local}} approaches are completely opposite in the map development. Conversely, the third map is the product of the presented algorithm: it is made based on the minimum travel time necessary to reach the destination, preserving the condition of safety during navigation.
\newpage
\begin{algorithm}[h]
	\small
	\caption{\textbf{\textit{Improved method}} approach}\label{improvedlocal}
	\KwData{\\
		%$H_{m0}\gets array(time, latitude, longitude)$\;
		%$cost \gets$ \textit{boolean} $array(time, latitude, longitude)$\;
		$N \gets$ \textit{number of available time windows}\;
	    $N_b \gets$ \textit{number of temporal bands to reach destination}\;
       	$[(o_x,o_y)]\gets$ \textit{list of x and y coordinates of obstacles of \textbf{Local} approach}\;
        $image \gets $ \texttt{np.zeros}((len(latitude), len(longitude)));}

	\KwResult{Points $(x,y)$ of the final path}
	\Comment{\textcolor{blue}{// Creation of the multidimensional masked array}}
	\For{$k$ in range(len(latitude))}{
		\For{$j$ in range(len(longitude))}{
			$geodist \gets$ \textit{geodetic distance between point}\texttt{[k][j]} \textit{and the harbor}\;
			\textit{depending on $geodist$ select the temporal band $b_q$ and generate the}\\ \textit{masked array} \texttt{band\_map[q][s][k][j]}, \textit{where} \\ $q=0,\ldots,N_b-1$, \textit{and} $s=0,\dots,N-1$;}}
			%\For{q in range($N_b$)}{
				%\If{$18(q)<$ \textit{geo distance} $<18(q+1)$}{
					%\textit{generate the mask image band\_map\texttt{[q][s][k][j]}};
					%\For{s in range($N$)}{
					%	\If{cost\texttt{[s][k][j]}}{
					%		band\_map\texttt{[q][s][k][j]}=1;
					%	}
					%}
				%}
			%}
	\textit{Run the planner using} $[(o_x,o_y)]$ \textit{as obstacles}; \Comment{\footnotesize \textcolor{blue}{// Planning with \textbf{\textit{Local}}}}\
	$T_{max}=[1,2,\ldots,N_b+1]$\;
	\While{condition 6 is not \texttt{True}}{
		\textit{oversample the resulting path and the edges of the bands}\;
		\textit{find the intersections} $P_i$ using \texttt{np.allclose}\;
		\For{$i$ in range($N_b$)}{
		\textit{compute} $f_i$ and ${f_{tot}}_i$\;
		\textit{verify condition} 6: ${f_{tot}}_i < {T_{max}}_i$;}
		\If{condition 6 $=$ \texttt{True}}{
			\textit{return} $(x,y)$ \textit{points of the safest path};}
		\Else{
			\textit{image $\gets$ weather map update by adding contributions of} \texttt{band\_map}\;
			\textit{recalculate} ${T_{max}}_i$\;
			\textit{wave contour} $=$ \texttt{np.logical\_xor}(\textit{image,} \texttt{binary\_erosion}(\textit{image}))\;
			\textit{repeat the path planning with RRT*};}
		}
		%path\_h = [\texttt{round}(path\_dist[j]/18,2) for $j$ in range(len(path\_dist))]\;
		%path\_until\_map = [\texttt{round}(\texttt{np.sum}(path\_h\texttt{[:j]}),2) for $j$ in range(1,len(path\_dist)$+1$)]
\end{algorithm}
\begin{figure}[H]
	\centering 
	\subfloat[]{\includegraphics[width=0.32\textwidth]{Figures/costsumtry.png}\label{sumcost}}
	\hspace{0.1cm}
	\subfloat[]{\includegraphics[width=0.32\textwidth]{Figures/costlocaltry.png}\label{localcost}}
	\hspace{0.1cm}
	\subfloat[]{\includegraphics[width=0.32\textwidth]{Figures/tryband.png}\label{imprcost}}
	\vspace{0.0cm}
	\caption{Difference between the maps made by three approaches} 
	\label{compsumlocimpr}
\end{figure}
\newpage
Figure \ref{localproblem} depicts two examples that confirms the problem of \textbf{\textit{Local}}'s initial hypothesis. In the first one, we see the route that avoids the obstacles viewed by \textbf{\textit{Local}}. From the travel time marked at the end of each band, we can note that the boat will take more than 1 hour to cross the temporal bands, especially in the second part of the navigation. This action must be addressed by considering additional time windows. For example, since the first band is traveled in 1.06 h $> 1$ h, we will consider $t_0+t_1$ for $b_0$; for the second band $1.06+0.96>2$ h, meaning $t_1+t_2$ and so on. The re-planned path is represented in the right chart: in this case, the condition of ${f_{tot}}_j< {T_{max}}_j$ is met, and this is verified by the fact that the unsafe region for a possible next iteration overlaps with the current map. \\ 
%This example proves that \textbf{\textit{Local}} does not always guarantee safe navigation, unlike the new approach.
%The other figures reiterate this statement: 
In the second example, using \textbf{\textit{Local}} may cause sinking, while with the \textbf{\textit{Improved method}}, the boat does not sail because wave conditions prevent navigation.  

\begin{figure}[H]
	\centering 
	\captionsetup{font=footnotesize,labelfont=footnotesize}
	\subfloat[]{\includegraphics[width=0.40\textwidth]{Figures/loc+1impr.png}\label{localiter}}
	\hspace{0.5cm}
	\subfloat[]{\includegraphics[width=0.40\textwidth]{Figures/loc+3impr.png}\label{impriter}}
	\hspace{0.5cm}
	\subfloat[]{\includegraphics[width=0.40\textwidth]{Figures/locsiimpno.png}\label{locsi}}
	\hspace{0.5cm}
	\subfloat[]{\includegraphics[width=0.40\textwidth]{Figures/locsiimpno2.png}\label{imprno}}
	\vspace{0.0cm}
	%\captionsetup[subfigure]{font=tiny,labelfont=tiny}
	\caption{(a),(c) Safety risk and potential sinking with \textbf{\textit{Local}}. (b),(d) Safety guaranteed and navigation not allowed with \textbf{\textit{Improved method}}.}
	\label{localproblem}
\end{figure}
% Map correction from \textbf{\textit{Local}} to the \textbf{\textit{Improved method}} approach
\section{Simulations}
The new approach is tested in 12 simulation days, with two survey points and considering the reverse routes (some of these latter are displayed in the \hyperref[appendix]{Appendix}). Only RRT* has been exploited for path planning, having obtained better results than A* and APF in \autoref{results}. Below here are the two detailed tables with travel time $T_{path}$ and computing time $t_{exec}$ of the nautical routes from Porto Vecchio. 
\begin{figure}[H]
	\centering
	\subfloat[Day 1]{\includegraphics[width=0.32\textwidth]{Figures/day1impr1.png}\label{day1impr1}}
	\hspace{0.1cm}
	\subfloat[Day 2]{\includegraphics[width=0.32\textwidth]{Figures/day2impr1.png}\label{day2impr1}}
	\hspace{0.1cm}
	\subfloat[Day 3]{\includegraphics[width=0.32\textwidth]{Figures/day3impr1.png}\label{day3impr1}}
	\hspace{0.1cm}
	\subfloat[Day 4]{\includegraphics[width=0.32\textwidth]{Figures/day4impr1.png}\label{day4impr1}}
	\hspace{0.1cm}
	\subfloat[Day 5]{\includegraphics[width=0.32\textwidth]{Figures/day5impr1.png}\label{day5impr1}}
	\hspace{0.1cm}
	\subfloat[Day 6]{\includegraphics[width=0.32\textwidth]{Figures/day6impr1.png}\label{day6impr1}}
	\hspace{0.1cm}
	\subfloat[Day 7]{\includegraphics[width=0.32\textwidth]{Figures/day7impr1.png}\label{day7impr1}}
	\hspace{0.1cm}
	\subfloat[Day 8]{\includegraphics[width=0.32\textwidth]{Figures/day8impr1.png}\label{day8impr1}}
	\hspace{0.1cm}
	\subfloat[Day 9]{\includegraphics[width=0.32\textwidth]{Figures/day9impr1.png}\label{day9impr1}}
	\vspace{0.0cm}
	\caption{Argentario survey Day 1 to 9 - \textbf{\textit{Improved method}}} 
	\label{Survey1impr}
\end{figure}
\newpage
\begin{figure}[H]
	\centering 
	\subfloat[Day 10]{\includegraphics[width=0.32\textwidth]{Figures/day10impr1.png}\label{day10impr1}}
	\hspace{0.1cm}
	\subfloat[Day 11]{\includegraphics[width=0.32\textwidth]{Figures/day11impr1.png}\label{day11impr1}}
	\hspace{0.1cm}
	\subfloat[Day 12]{\includegraphics[width=0.32\textwidth]{Figures/day12impr1.png}\label{day12impr1}}
	\vspace{0.0cm}
	%\captionsetup{font=normalsize,labelfont=footnotesize}
	\caption{Argentario survey Day 10 to 12 - \textbf{\textit{Improved method}}} 
	\label{Survey1impr1}
\end{figure}
\begin{table}[!htbp]
	\centering
	\resizebox{\textwidth}{!}{%
		\renewcommand{\arraystretch}{1.5}
		\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|c|c|c|c|}
			\hline
			\multicolumn{2}{|c|}{} & \textbf{Day 1} & \textbf{Day 2} & \textbf{Day 3} & \textbf{Day 4} & \textbf{Day 5} & \textbf{Day 6} & \textbf{Day 7} & \textbf{Day 8} &\textbf{Day 9} & \textbf{Day 10} & \textbf{Day 11} & \textbf{Day 12} \bigstrut\\
			\hline
			\multicolumn{1}{|c|}{\multirow{2}[4]{*}{\parbox{5em}{\centering \textbf{RRT*} \textit{Improved method}}}} & $T_{path}$($h$) & 9.88  & 9.12  & 10.20  & 10.42  & 10.20  & 10.15 & 11.00  & 9.78  & 9.51  & 9.51  & 9.88  & 9.68 \bigstrut\\
			\cline{2-14}          & $t_{exec}$($s$) & 94.917 & 73.043 & 96.444 & 117.157 & 107.686 & 106.792 & 118.273 & 74.561 & 114.337 & 92.934 & 83.794 & 82.465 \bigstrut\\
			\hline
	\end{tabular}}%
	\caption{Argentario survey - Travel and computing time}
	\label{tab:addlabel3}%
\end{table}%
\begin{figure}[H]
	\centering 
	\subfloat[Day 1]{\includegraphics[width=0.32\textwidth]{Figures/day1impr2.png}\label{day1impr2}}
	\hspace{0.1cm}
	\subfloat[Day 2]{\includegraphics[width=0.32\textwidth]{Figures/day2impr2.png}\label{day2impr2}}
	\hspace{0.1cm}
	\subfloat[Day 3]{\includegraphics[width=0.32\textwidth]{Figures/day3impr2.png}\label{day3impr2}}
	\hspace{0.1cm}
	\subfloat[Day 4]{\includegraphics[width=0.32\textwidth]{Figures/day4impr2.png}\label{day4impr2}}
	\hspace{0.1cm}
	\subfloat[Day 5]{\includegraphics[width=0.32\textwidth]{Figures/day5impr2.png}\label{day5impr2}}
	\hspace{0.1cm}
	\subfloat[Day 6]{\includegraphics[width=0.32\textwidth]{Figures/day6impr2.png}\label{day6impr2}}
	\hspace{0.1cm}
	\vspace{0.0cm}
	\caption{Elba Island survey Day 1 to 6 - \textbf{\textit{Improved method}}} 
	\label{Survey2impr1}
\end{figure}
\newpage
\begin{figure}[H]
	\centering
	\subfloat[Day 7]{\includegraphics[width=0.32\textwidth]{Figures/day7impr2.png}\label{day7impr2}}
	\hspace{0.1cm}
	\subfloat[Day 8]{\includegraphics[width=0.32\textwidth]{Figures/day8impr2.png}\label{day8impr2}}
	\hspace{0.1cm}
	\subfloat[Day 9]{\includegraphics[width=0.32\textwidth]{Figures/day9impr2upd.png}\label{day9impr2}}
	\hspace{0.1cm}
	\subfloat[Day 10]{\includegraphics[width=0.32\textwidth]{Figures/day10impr2.png}\label{day10impr2}}
	\hspace{0.1cm}
	\subfloat[Day 11]{\includegraphics[width=0.32\textwidth]{Figures/day11impr2.png}\label{day11impr2}}
	\hspace{0.1cm}
	\subfloat[Day 12]{\includegraphics[width=0.32\textwidth]{Figures/day12impr2.png}\label{day12impr2}}
	\vspace{0.0cm}
	\caption{Elba Island survey Day 7 to 12 - \textbf{\textit{Improved method}}} 
	\label{Survey2impr}
\end{figure}
% Table generated by Excel2LaTeX from sheet 'Foglio1'


\begin{table}[!htbp]
	\centering	
	\resizebox{\textwidth}{!}{%
		\renewcommand{\arraystretch}{1.5}
		\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|c|c|c|c|}
			\hline
			\multicolumn{2}{|c|}{} & \textbf{Day 1} & \textbf{Day 2} & \textbf{Day 3} & \textbf{Day 4} & \textbf{Day 5} & \textbf{Day 6} & \textbf{Day 7} & \textbf{Day 8} &\textbf{Day 9} & \textbf{Day 10} & \textbf{Day 11} & \textbf{Day 12} \bigstrut\\
			\hline
			\multicolumn{1}{|c|}{\multirow{2}[4]{*}{\parbox{5em}{\centering \textbf{RRT*} \textit{Improved method}}}} & $T_{path}$($h$) & 8.56  & 8.47  & 8.83  & 8.72  & 8.58  & 8.66  & 9.04  & 8.76  & 9.83  & 8.79  & 8.79  & 8.49 \bigstrut\\
			\cline{2-14} & $t_{exec}$($s$) & 84.639 & 74.349 & 87.418 & 87.165 & 81.896 & 79.588 & 142.700 & 79.866 & 75.743 & 79.065 & 81.206 & 114.583 \bigstrut\\
			\hline
	\end{tabular}}%
	\caption{Elba Island survey - Travel and computing time}
	\label{tab:addlabel5}%
\end{table}%

By carefully comparing the charts just plotted with the ones of \textbf{\textit{Local}} in \autoref{results}, there are no substantial differences. However, those small changes in the maps could mean the success or failure of the whole mission, as seen in Figure \ref{localproblem}. The most evident changes in $\mathcal{C}_{obs}$ occur on Day 4, 5, 6, 9, 10, and 11.\\
%One last note regarding the high computing time: 
From Table \ref{tab:addlabel3} and \ref{tab:addlabel5}, the values of $t_{exec}$ catch the eye at first glance. This aspect is due to the expensive functions of the recursive algorithm, which repeats its operations until it finds a viable path. Nevertheless, we remember that time optimization is unnecessary for this application, and computing time of a couple of minutes is acceptable.
\newpage
\section{Results}
The performance of the \textbf{\textit{Improved method}} is evaluated through a comparison of the path lengths and a measure of the efficiency and safety index.

Figure \ref{traveltimeimpr} compares the four approaches in the simulations performed by RRT*. 
%Excluding \textbf{\textit{Sum}}, whose possible paths are $7.1\%$ longer, and \textbf{\textit{Global}} the other two have provided very close results. 
\textbf{\textit{Local}} represents the fastest approach, followed closely by the \textbf{\textit{Improved method}}, and then \textbf{\textit{Global}} and \textbf{\textit{Sum}}, whose possible paths are respectively $2.3\%$ and $7.3\%$ longer. A $0.1\%$ variation of the new approach denotes a remarkable similarity with \textbf{\textit{Local}}, even though it considers more time windows.
%to compare the two metrics: in the basic approaches, it is difficult to achieve high values in both cases. With the new approach both metrics are maximized.
\vspace{1cm}
\begin{figure}[h]
	\centering
	\includegraphics[width=75mm]{Figures/barimprovednew2.png}
	\caption{Comparison of travel time using RRT* divided by approaches}
	\label{traveltimeimpr}
\end{figure} 
\vspace{0.5cm}
\begin{table}[htbp]
	\centering
	\renewcommand{\arraystretch}{2}
	\begin{tabular}{|c|c|c|c|c|c|}
		\hline
		\multicolumn{2}{|c|}{} & \textit{Sum}  & \textit{Global} & \textit{Local} & \parbox{4em}{\centering \small \textit{Improved method}} \bigstrut[b]\\
		\hline
		\multicolumn{1}{|c|}{\multirow{2}[4]{*}{\textbf{RRT*}}} & \parbox{4em}{\centering \small Mean $T_{path}$($h$)} & 9.6  & 9.19  & 8.99  & 9.0 \bigstrut[b]\\
		\cline{2-6}          & \parbox{4em}{\centering \scriptsize Variation (\%) w.r.t. $min(T_{path})$} & 7.3   & 2.3   & 0.0   & 0.1 \bigstrut[b]\\
		\hline
	\end{tabular}%
	\caption{Data comparison of travel time using RRT* divided by approaches}
	\label{tabl improved}%
\end{table}%
\newpage
Table \ref{tabl improved} exposes the quantitative results depicted in the previous figure. These outcomes are related to the respective degree of safety, illustrated in Figure \ref{compeffsaf} and \ref{safeeffimpr} together with the efficiency index. Safety determines the amount of obstacles on the map, so higher values push the boat to be more careful and find longer paths.

From the barplots, we can see how the \textbf{\textit{Improved method}} achieves similar values to \textbf{\textit{Local}}, reaching an efficiency of 85.4\%, still preserving the 100\% safety assurance, as \textbf{\textit{Sum}} and \textbf{\textit{Global}}. The same results are summarized in the 2D plot of Figure \ref{safeeffimpr}.
\begin{figure}[H]
	\centering 
	\subfloat[Efficiency index]{\includegraphics[width=0.47\textwidth]{Figures/efficiencyimpr.png}\label{effimpr}}
	\hspace{0.3cm}
	\subfloat[Safety index]{\includegraphics[width=0.47\textwidth]{Figures/safetyimpr.png}\label{safimpr}}
	\vspace{0.0cm}
	\captionsetup{font=footnotesize,labelfont=footnotesize}
	\caption{Comparison of performance metrics between the 4 spatio-temporal approaches} 
	\label{compeffsaf}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[width=85mm]{Figures/safety_effimpr.png}
	\caption{Efficiency-safety chart}
	\label{safeeffimpr}
\end{figure} 
\section{Summary}
In this chapter, we have developed an innovative approach to consider large hourly time-varying areas of obstacles \textit{a priori}, represented by risky wave conditions.\\
The \textbf{\textit{Improved method}} has achieved excellent results at the cost of computing time of a few minutes. It has solved the two issues encountered with the basic approaches regarding efficiency and safety during navigation.
%\section{Uncertainty of the forecasts} 
%We know that predictions suffer of a grade of uncertainty: they are not exact, especially if they provide information at very small resolution, as in this case. Although they are short-range forecasts (1-2 days), itâ€™s better to account for the variability.


